<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lightcontroller</title>
</head>

<body>
    <h3>Lightcontroller</h3>
    <div id="lightcontrols"></div>
    <div id="lightcontrolsgroup"></div>
    <div id="lightcontrolsall"></div>
</body>

</html>
<script>
    const url = new URL(document.baseURI);
    const lights = "SomeName0;0;group1\nSomeName1;1;group1";
    let groups = {};
    lights.split("\n").forEach(line => {
        let splits = line.split(";");
        if (!groups[splits[2]]) groups[splits[2]] = [];
        groups[splits[2]].push(line);
    });
    let cached = {};

    class functions {
        static request = (u, options) => {
            return new Promise((resolve, reject) => {
                if (!/^http(s)*:\/{2}/i.test(u)) u = url.origin + u;
                options = (options ?? {});

                fetch(u, options)
                    .then(v => {
                        resolve(v.body);
                    })
                    .catch(reject);
            });
        };
    };

    class scripts {
        static loadLights = () => {
            lights.split("\n").forEach(line => {
                let [lightName, lightDmxAddress, lightGroupName] = line.split(";");

                let controlsContainer = document.createElement("div");
                controlsContainer.classList.add("controlsContainer");

                let controlsTitle = document.createElement("h");
                controlsTitle.classList.add("controlsTitle");
                controlsTitle.innerText = lightName;

                let controlsGroupTitle = document.createElement("h");
                controlsGroupTitle.classList.add("controlsGroupTitle");
                controlsGroupTitle.innerText = lightGroupName;

                let controlsColorInput = elements.controlsColorInput();

                let controlsDimmerInput = elements.controlsDimmerInput();

                let controlsSubmit = document.createElement("button");
                controlsSubmit.innerText = "Update";
                controlsSubmit.onclick = () => {
                    let pickedColor = controlsColorInput.value;
                    let pickedDimm = controlsDimmerInput.value;

                    console.log("submitting data for", lightName, "dmx address", lightDmxAddress, "color", pickedColor, "dimm", pickedDimm);
                    functions.request("/update", {
                        method: "POST",
                        headers: {
                            dmxAddresses: lightDmxAddress,
                            colors: pickedColor,
                            dimms: pickedDimm
                        }
                    });
                };

                [controlsTitle, elements.br(), controlsGroupTitle, elements.br(), elements.spacer(), controlsColorInput, elements.br(), controlsDimmerInput, elements.br(), controlsSubmit].forEach(a => controlsContainer.appendChild(a));

                document.querySelector("#lightcontrols").appendChild(controlsContainer);
            });
        };

        static loadLightGroups = () => {
            let groupControlsContainer = document.createElement("div");
            groupControlsContainer.classList.add("groupControlsContainer");

            let groupControlsTitle = document.createElement("h");
            groupControlsTitle.innerText = "Group Controls";

            let groupSelector = document.createElement("select");
            Object.keys(groups).forEach(group => {
                let groupOption = document.createElement("option");
                groupOption.innerText = group;
                groupOption.value = group;
                groupSelector.appendChild(groupOption);
            });

            let groupControlsColorInput = elements.controlsColorInput();
            let groupControlsDimmerInput = elements.controlsDimmerInput();

            let groupControlsSubmit = document.createElement("button");
            groupControlsSubmit.innerText = "Update";
            groupControlsSubmit.onclick = () => {
                let pickedColor = groupControlsColorInput.value;
                let pickedDimm = groupControlsDimmerInput.value;
                let pickedGroup = groupSelector.value;

                functions.request("/update", {
                    method: "POST",
                    headers: {
                        dmxAddresses: groups[pickedGroup].map(a => a.split(";")[1]).join(";"),
                        colors: pickedColor,
                        dimms: pickedDimm
                    }
                });
            };

            [groupControlsTitle, elements.br(), elements.spacer(), groupSelector, elements.br(), elements.spacer(), groupControlsColorInput, elements.br(), groupControlsDimmerInput, elements.br(), groupControlsSubmit].forEach(a => groupControlsContainer.appendChild(a));

            document.querySelector("#lightcontrolsgroup").appendChild(groupControlsContainer);
        };

        static loadLightAll = () => {
            let allControlsContainer = document.createElement("div");
            allControlsContainer.classList.add("groupControlsContainer");

            let allControlsTitle = document.createElement("h");
            allControlsTitle.innerText = "Master Controls";

            let allControlsColorInput = elements.controlsColorInput();
            let allControlsDimmerInput = elements.controlsDimmerInput();

            let allControlsSubmit = document.createElement("button");
            allControlsSubmit.innerText = "Update";
            allControlsSubmit.onclick = () => {
                let pickedColor = allControlsColorInput.value;
                let pickedDimm = allControlsDimmerInput.value;

                functions.request("/update", {
                    method: "POST",
                    headers: {
                        dmxAddresses: lights.split("\n").map(a => a.split(";")[1]).join(";"),
                        colors: pickedColor,
                        dimms: pickedDimm
                    }
                });
            };

            [allControlsTitle, elements.br(), elements.spacer(), allControlsColorInput, elements.br(), allControlsDimmerInput, elements.br(), allControlsSubmit].forEach(a => allControlsContainer.appendChild(a));

            document.querySelector("#lightcontrolsall").appendChild(allControlsContainer);
        };
    };

    class elements {
        static br = () => { return document.createElement("br") };
        static spacer = () => { return document.createElement("spacer") };

        static controlsColorInput = () => {
            let controlsColorInput = document.createElement("input");
            controlsColorInput.classList.add("controlsColorInput");
            controlsColorInput.type = "color";
            controlsColorInput.defaultValue = "#FFFFFF"

            return controlsColorInput;
        };

        static controlsDimmerInput = () => {
            let controlsDimmerInput = document.createElement("input");
            controlsDimmerInput.classList.add("controlsDimmerInput");
            controlsDimmerInput.type = "range";
            controlsDimmerInput.value = "0";
            controlsDimmerInput.min = "0";
            controlsDimmerInput.max = "100";
            controlsDimmerInput.defaultValue = "0";

            return controlsDimmerInput;
        };

    };

    window.onload = () => { scripts.loadLights(); scripts.loadLightGroups(); scripts.loadLightAll() };
</script>
<style>
    * {
        scrollbar-width: thin;
        font-family: "Trebuchet MS", "Lucida Sans Unicode", "Lucida Grande", "Lucida Sans", Arial, sans-serif;
        border-radius: 5px;
        word-break: normal;
        line-break: anywhere;
        text-align: center;
        user-select: none;
        padding: 3px;
    }

    body {
        background-color: #233d4d;
        transition: ease-in 2s;
        color: #f1faee;
        padding: 3px;
    }

    #lightcontrols {
        /* display: grid; */
        place-items: center;
    }

    .controlsContainer,
    .groupControlsContainer {
        padding: 3px;
        width: 25%;
        display: inline-block;
        border: 1px solid;
        background-color: #1d2d44;
    }

    spacer {
        display: flex;
        height: 10px;
    }

    .controlsTitle {
        font-size: large;
    }

    .controlsGroupTitle {
        font-size: small;
    }
</style>